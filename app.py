import streamlit as st
import gspread
import pandas as pd
from algoritmo import buscar_permutas_por_nome
import unicodedata
import plotly.graph_objects as go
from collections import Counter

# ===============================
# Configura√ß√£o da p√°gina
# ===============================
st.set_page_config(
    page_title="Busca de Permutas",
    page_icon="‚öñÔ∏è",
    layout="wide"
)

# ===============================
# Fun√ß√µes auxiliares
# ===============================
def normalizar_texto(texto):
    if not isinstance(texto, str):
        return ""
    texto_norm = unicodedata.normalize('NFKD', texto)
    texto_sem_acento = ''.join(c for c in texto_norm if not unicodedata.combining(c))
    return texto_sem_acento.strip().lower()

def obter_prioridade_destino(origem_juiz, destino_final, df):
    """Retorna a prioridade do destino (1, 2 ou 3) para um juiz"""
    juiz_row = df[df["Origem"] == origem_juiz]
    if len(juiz_row) == 0:
        return ""
    
    juiz_data = juiz_row.iloc[0]
    if juiz_data.get("Destino 1") == destino_final:
        return "¬π"
    elif juiz_data.get("Destino 2") == destino_final:
        return "¬≤"
    elif juiz_data.get("Destino 3") == destino_final:
        return "¬≥"
    return ""

def calcular_estatisticas(df):
    """Calcula estat√≠sticas para os dashboards"""
    # Tribunais mais procurados
    destinos = []
    for col in ["Destino 1", "Destino 2", "Destino 3"]:
        destinos.extend(df[col].dropna().tolist())
    tribunais_procurados = Counter(destinos).most_common(5)
    
    # Tribunais mais exportadores
    tribunais_exportadores = df["Origem"].value_counts().head(5)
    
    # Tribunais hubs
    todas_localizacoes = set(df["Origem"].unique())
    for col in ["Destino 1", "Destino 2", "Destino 3"]:
        todas_localizacoes.update(df[col].dropna().unique())
    
    hub_scores = {}
    for tribunal in todas_localizacoes:
        score = len(df[df["Origem"] == tribunal])
        for col in ["Destino 1", "Destino 2", "Destino 3"]:
            score += len(df[df[col] == tribunal])
        hub_scores[tribunal] = score
    
    tribunais_hubs = sorted(hub_scores.items(), key=lambda x: x[1], reverse=True)[:5]
    
    return tribunais_procurados, tribunais_exportadores, tribunais_hubs

# ===============================
# CSS personalizado
# ===============================
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    
    html, body, [class*="css"] {
        font-family: 'Inter', sans-serif;
    }
    
    .main-header {
        font-family: 'Inter', sans-serif;
        font-weight: 700;
        font-size: 3.5rem;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }
    
    .sub-header {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 1.3rem;
        text-align: center;
        color: #6c757d;
        margin-bottom: 2rem;
        line-height: 1.5;
    }
    
    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        text-align: center;
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #495057;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    </style>
""", unsafe_allow_html=True)

# ===============================
# Fun√ß√£o para carregar dados
# ===============================
@st.cache_data
def carregar_dados():
    creds_dict = st.secrets["google_service_account"]
    gc = gspread.service_account_from_dict(creds_dict)
    sheet = gc.open("Permuta - Magistratura Estadual").sheet1
    data = sheet.get_all_values()
    df = pd.DataFrame(data[1:], columns=data[0])

    # Limpeza de dados
    if "Entr√¢ncia" not in df.columns:
        df["Entr√¢ncia"] = None

    for coluna in ["Destino 1", "Destino 2", "Destino 3", "E-mail", "Entr√¢ncia"]:
        if coluna in df.columns:
            df[coluna] = df[coluna].apply(lambda x: str(x).strip() if pd.notnull(x) and str(x).strip() != "" else None)

    df["Nome"] = df["Nome"].str.strip()
    df["Origem"] = df["Origem"].str.strip()
    
    # Filtrar apenas registros v√°lidos
    df = df[df["Nome"].notna() & (df["Nome"] != "") & df["Origem"].notna() & (df["Origem"] != "")]
    
    return df

# ===============================
# Interface principal
# ===============================
st.markdown('<h1 class="main-header">Busca de Permutas</h1>', unsafe_allow_html=True)
st.markdown('<p class="sub-header">Sistema colaborativo e gratuito para interessados projetarem casais de permuta, triangula√ß√£o e quadrangula√ß√£o</p>', unsafe_allow_html=True)

# Bot√£o para atualizar dados
col_update1, col_update2, col_update3 = st.columns([1, 2, 1])
with col_update2:
    if st.button("üîÑ Atualizar base de dados agora"):
        st.cache_data.clear()
        st.success("‚úÖ Base de dados atualizada!")

# Carregar dados
df = carregar_dados()

# Login por e-mail
emails_autorizados = set(df["E-mail"].dropna().unique())
email_user = st.text_input("Digite seu e-mail para acessar a aplica√ß√£o:")

if email_user not in emails_autorizados:
    st.warning("‚ö†Ô∏è Acesso restrito. Seu e-mail n√£o est√° cadastrado na base de dados.")
    st.stop()

# Estat√≠sticas
tribunais_procurados, tribunais_exportadores, tribunais_hubs = calcular_estatisticas(df)

# M√©tricas num√©ricas
col1, col2, col3 = st.columns(3)
with col1:
    st.markdown(f"""
    <div class="metric-card">
        <div class="metric-number">{len(df)}</div>
        <div class="metric-label">Ju√≠zes Cadastrados</div>
    </div>
    """, unsafe_allow_html=True)

with col2:
    num_permutas = len(df) * (len(df) - 1) // 2
    st.markdown(f"""
    <div class="metric-card">
        <div class="metric-number">{num_permutas}</div>
        <div class="metric-label">Permutas Poss√≠veis</div>
    </div>
    """, unsafe_allow_html=True)

with col3:
    tribunais_unicos = len(set(df["Origem"].unique()))
    st.markdown(f"""
    <div class="metric-card">
        <div class="metric-number">{tribunais_unicos}</div>
        <div class="metric-label">Tribunais Envolvidos</div>
    </div>
    """, unsafe_allow_html=True)

# Gr√°ficos estat√≠sticos
st.markdown("### üìä Estat√≠sticas dos Tribunais")
col1, col2, col3 = st.columns(3)

with col1:
    if tribunais_procurados:
        fig = go.Figure(data=[go.Bar(
            x=[item[1] for item in tribunais_procurados],
            y=[item[0] for item in tribunais_procurados],
            orientation='h',
            marker_color='#667eea'
        )])
        fig.update_layout(title="üéØ Tribunais Mais Procurados", height=300)
        st.plotly_chart(fig, use_container_width=True)

with col2:
    if not tribunais_exportadores.empty:
        fig = go.Figure(data=[go.Bar(
            x=tribunais_exportadores.values,
            y=tribunais_exportadores.index,
            orientation='h',
            marker_color='#fd79a8'
        )])
        fig.update_layout(title="üì§ Tribunais Mais Exportadores", height=300)
        st.plotly_chart(fig, use_container_width=True)

with col3:
    if tribunais_hubs:
        fig = go.Figure(data=[go.Bar(
            x=[item[1] for item in tribunais_hubs],
            y=[item[0] for item in tribunais_hubs],
            orientation='h',
            marker_color='#00cec9'
        )])
        fig.update_layout(title="üîó Tribunais Hubs", height=300)
        st.plotly_chart(fig, use_container_width=True)

# ===============================
# Busca por nome
# ===============================
st.markdown("### üîç Escolha seus crit√©rios")

# Sele√ß√£o do nome
nomes_disponiveis = sorted(df["Nome"].unique())
nome_selecionado = st.selectbox("üë§ Selecione seu nome:", [""] + nomes_disponiveis)

# Tipos de busca
st.markdown("**Tipos de combina√ß√µes a buscar:**")
col1, col2, col3 = st.columns(3)
with col1:
    buscar_casais = st.checkbox("üíë Permuta Bilateral (Casal)", value=True)
with col2:
    buscar_triangulos = st.checkbox("üî∫ Triangula√ß√£o", value=True)
with col3:
    buscar_quadrangulos = st.checkbox("üî∑ Quadrangula√ß√£o", value=True)

# Busca
if st.button("üîç Buscar Permutas e Combina√ß√µes"):
    if not nome_selecionado:
        st.warning("‚ö†Ô∏è Por favor, selecione seu nome para realizar a busca.")
        st.stop()
    
    # Buscar combina√ß√µes usando a fun√ß√£o que funciona
    casais, triangulos, quadrangulos = buscar_permutas_por_nome(df, nome_selecionado)
    
    resultados_encontrados = False
    
    # Exibir casais
    if buscar_casais and casais:
        resultados_encontrados = True
        st.success(f"üéØ **{len(casais)} permuta(s) direta(s) encontrada(s):**")
        st.markdown("**Legenda:** üîµ Destino 1 | üü¢ Destino 2 | üî¥ Destino 3")
        
        # Tabela simplificada
        casais_tabela = []
        for casal in casais:
            prioridade_a = obter_prioridade_destino(casal["Origem A"], casal["Destino A"], df)
            prioridade_b = obter_prioridade_destino(casal["Origem B"], casal["Destino B"], df)
            
            casais_tabela.append({
                "üë§ Seu Nome": casal["Juiz A"],
                "üìç Sua Origem": casal["Origem A"],
                "üéØ Voc√™ vai para": f"{casal['Destino A']}{prioridade_a}",
                "ü§ù Parceiro": casal["Juiz B"],
                "üìç Origem do Parceiro": casal["Origem B"],
                "üéØ Parceiro vai para": f"{casal['Destino B']}{prioridade_b}"
            })
        
        st.dataframe(pd.DataFrame(casais_tabela), use_container_width=True, hide_index=True)
    
    # Exibir triangula√ß√µes
    if buscar_triangulos and triangulos:
        resultados_encontrados = True
        st.success(f"üî∫ **{len(triangulos)} triangula√ß√£o(√µes) encontrada(s):**")
        st.markdown("**Legenda:** üîµ Destino 1 | üü¢ Destino 2 | üî¥ Destino 3")
        
        triangulos_tabela = []
        for i, tri in enumerate(triangulos, 1):
            prioridade_a = obter_prioridade_destino(tri["Origem A"], tri["A ‚ûù"], df)
            prioridade_b = obter_prioridade_destino(tri["Origem B"], tri["B ‚ûù"], df)
            prioridade_c = obter_prioridade_destino(tri["Origem C"], tri["C ‚ûù"], df)
            
            fluxo = f"{tri['Juiz A']} ‚Üí {tri['A ‚ûù']}{prioridade_a} ‚Üí {tri['Juiz B']} ‚Üí {tri['B ‚ûù']}{prioridade_b} ‚Üí {tri['Juiz C']} ‚Üí {tri['C ‚ûù']}{prioridade_c}"
            
            triangulos_tabela.append({
                "üî¢": f"#{i}",
                "üë§ Participante A": f"{tri['Juiz A']} ({tri['Origem A']})",
                "üë§ Participante B": f"{tri['Juiz B']} ({tri['Origem B']})",
                "üë§ Participante C": f"{tri['Juiz C']} ({tri['Origem C']})",
                "üîÑ Fluxo": fluxo
            })
        
        st.dataframe(pd.DataFrame(triangulos_tabela), use_container_width=True, hide_index=True)
    
    # Exibir quadrangula√ß√µes
    if buscar_quadrangulos and quadrangulos:
        resultados_encontrados = True
        st.success(f"üî∑ **{len(quadrangulos)} quadrangula√ß√£o(√µes) encontrada(s):**")
        st.markdown("**Legenda:** üîµ Destino 1 | üü¢ Destino 2 | üî¥ Destino 3")
        
        quadrangulos_tabela = []
        for i, quad in enumerate(quadrangulos, 1):
            prioridade_a = obter_prioridade_destino(quad["Origem A"], quad["A ‚ûù"], df)
            prioridade_b = obter_prioridade_destino(quad["Origem B"], quad["B ‚ûù"], df)
            prioridade_c = obter_prioridade_destino(quad["Origem C"], quad["C ‚ûù"], df)
            prioridade_d = obter_prioridade_destino(quad["Origem D"], quad["D ‚ûù"], df)
            
            fluxo = f"{quad['Juiz A']} ‚Üí {quad['A ‚ûù']}{prioridade_a} ‚Üí {quad['Juiz B']} ‚Üí {quad['B ‚ûù']}{prioridade_b} ‚Üí {quad['Juiz C']} ‚Üí {quad['C ‚ûù']}{prioridade_c} ‚Üí {quad['Juiz D']} ‚Üí {quad['D ‚ûù']}{prioridade_d}"
            
            quadrangulos_tabela.append({
                "üî¢": f"#{i}",
                "üë§ Participante A": f"{quad['Juiz A']} ({quad['Origem A']})",
                "üë§ Participante B": f"{quad['Juiz B']} ({quad['Origem B']})",
                "üë§ Participante C": f"{quad['Juiz C']} ({quad['Origem C']})",
                "üë§ Participante D": f"{quad['Juiz D']} ({quad['Origem D']})",
                "üîÑ Fluxo": fluxo
            })
        
        st.dataframe(pd.DataFrame(quadrangulos_tabela), use_container_width=True, hide_index=True)
    
    # Mensagens de aus√™ncia de resultados
    if buscar_casais and not casais:
        st.info("‚ÑπÔ∏è **Permuta Bilateral:** Nenhuma permuta direta encontrada. Isso ocorre quando n√£o h√° outro juiz que queira ir para sua origem e voc√™ tamb√©m queira ir para a origem dele.")
    
    if buscar_triangulos and not triangulos:
        st.info("‚ÑπÔ∏è **Triangula√ß√£o:** Nenhuma triangula√ß√£o encontrada. Para haver triangula√ß√£o, √© necess√°rio que existam tr√™s ju√≠zes onde A quer ir para onde B est√°, B quer ir para onde C est√°, e C quer ir para onde A est√°.")
    
    if buscar_quadrangulos and not quadrangulos:
        st.info("‚ÑπÔ∏è **Quadrangula√ß√£o:** Nenhuma quadrangula√ß√£o encontrada. Para haver quadrangula√ß√£o, √© necess√°rio que existam quatro ju√≠zes onde A quer ir para onde B est√°, B quer ir para onde C est√°, C quer ir para onde D est√°, e D quer ir para onde A est√°.")
    
    if not resultados_encontrados:
        st.info("‚ÑπÔ∏è **Nenhum resultado:** N√£o foram encontradas combina√ß√µes poss√≠veis com os crit√©rios selecionados.")

# Base completa
with st.expander("üìÇ Ver base de dados completa"):
    st.dataframe(df, use_container_width=True)

# Rodap√©
st.markdown("""
    <hr style='margin-top: 3rem;'>
    <div style='text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 15px;'>
        <p style='color: #6c757d;'>‚ö†Ô∏è <strong>Aplica√ß√£o colaborativa, gratuita e sem fins econ√¥micos.</strong></p>
        <p style='color: #6c757d;'>üóÇÔ∏è <strong>Dados voluntariamente informados pelos pr√≥prios titulares.</strong></p>
        <p style='color: #6c757d;'>üîí <strong>Acesso restrito por e-mail cadastrado.</strong></p>
        <p style='color: #495057;'>üí° <strong>Mentoria em IA: <a href="mailto:marciocarneirodemesquitajunior@gmail.com">contacte-nos</a></strong></p>
    </div>
""", unsafe_allow_html=True)